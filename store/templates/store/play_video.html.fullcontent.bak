{% extends 'store/base.html' %}
{% load static %}
{% block title %}Lecture : {{ video.title }}{% endblock %}
{% block videoP %}
<div class="spacer"></div>
<div class="main">
    <div class="list">
        <div class="list-item">
            <div class="main-player">
                <video controls poster="{{ video.thumbnail.url }}" preload="metadata" style="width:100%;max-width:900px;border-radius:10px;">
                    <source src="{{ video.file.url }}" type="video/mp4">
                    Votre navigateur ne supporte pas la lecture vid√©o.
                </video>
                <h2 style="margin-top:10px">{{ video.title }}</h2>
                <div class="video-stats">
                    <span><i class="fa-regular fa-eye"></i> {{ video.play_count }}</span>
                    <span style="margin-left:12px"><i class="fa-solid fa-download"></i> {{ video.download_count }}</span>
                    <span style="margin-left:12px"><i class="fa-regular fa-heart"></i> {{ video.like_count }}</span>
                </div>
            </div>
        </div>
    </div>

    <h3 style="margin-top:24px">Autres vid√©os de {{ video.artist.name }}</h3>
    <ul class="other-videos" style="list-style:none;padding:0;display:flex;flex-wrap:wrap;gap:12px;">
        {% for v in artist_videos %}
            <li style="flex:0 0 250px;">
                <a href="{% url 'video_detail' v.id %}" style="display:block;text-decoration:none;color:inherit;">
                    <img src="{{ v.thumbnail.url }}" alt="{{ v.title }}" style="width:100%;height:140px;object-fit:cover;border-radius:6px;" />
                    <strong style="display:block;margin-top:8px">{{ v.title }}</strong>
                    <div class="stats" style="font-size:0.9rem;color:#666;">
                        <span>{{ v.play_count }} vues</span>
                    </div>
                </a>
            </li>
        {% empty %}
            <li>Aucune autre vid√©o pour cet artiste.</li>
        {% endfor %}
    </ul>
</div>
{% endblock videoP %}
{% extends 'store/base.html' %}
{% load static %}
{% block title %}Lecture : {{ video.title }}{% endblock %}
{% block videoP %}
<div class="spacer"></div>
<div class="main">
    <div class="list">
        <div class="list-item">
            <div class="main-player">
                <video controls poster="{{ video.thumbnail.url }}" preload="metadata" style="width:100%;max-width:900px;border-radius:10px;">
                    <source src="{{ video.file.url }}" type="video/mp4">
                    Votre navigateur ne supporte pas la lecture vid√©o.
                </video>
                <h2 style="margin-top:10px">{{ video.title }}</h2>
                <div class="video-stats">
                    <span><i class="fa-regular fa-eye"></i> {{ video.play_count }}</span>
                    <span style="margin-left:12px"><i class="fa-solid fa-download"></i> {{ video.download_count }}</span>
                    <span style="margin-left:12px"><i class="fa-regular fa-heart"></i> {{ video.like_count }}</span>
                </div>
            </div>
        </div>
    </div>

    <h3 style="margin-top:24px">Autres vid√©os de {{ video.artist.name }}</h3>
    <ul class="other-videos" style="list-style:none;padding:0;display:flex;flex-wrap:wrap;gap:12px;">
        {% for v in artist_videos %}
            <li style="flex:0 0 250px;">
                <a href="{% url 'video_detail' v.id %}" style="display:block;text-decoration:none;color:inherit;">
                    <img src="{{ v.thumbnail.url }}" alt="{{ v.title }}" style="width:100%;height:140px;object-fit:cover;border-radius:6px;" />
                    <strong style="display:block;margin-top:8px">{{ v.title }}</strong>
                    <div class="stats" style="font-size:0.9rem;color:#666;">
                        <span>{{ v.play_count }} vues</span>
                    </div>
                </a>
            </li>
        {% empty %}
            <li>Aucune autre vid√©o pour cet artiste.</li>
        {% endfor %}
    </ul>
</div>
{% endblock videoP %}
{% extends 'store/base.html' %}
{% load static %}
{% block title %}Lecture : {{ video.title }}{% endblock %}
{% block videoP %}
    <div class="spacer"></div>
    <div class="main">
        <div class="list">
            <div class="list-item">
                <div class="main-player">
                    <video controls poster="{{ video.thumbnail.url }}" preload="metadata" style="width:100%;max-width:900px;border-radius:10px;">
                        <source src="{{ video.file.url }}" type="video/mp4">
                        Votre navigateur ne supporte pas la lecture vid√©o.
                    </video>
                    <h2 style="margin-top:10px">{{ video.title }}</h2>
                    <div class="video-stats">
                        <span><i class="fa-regular fa-eye"></i> {{ video.play_count }}</span>
                        <span style="margin-left:12px"><i class="fa-solid fa-download"></i> {{ video.download_count }}</span>
                        <span style="margin-left:12px"><i class="fa-regular fa-heart"></i> {{ video.like_count }}</span>
                    </div>
                </div>
            </div>
        </div>

        <h3 style="margin-top:24px">Autres vid√©os de {{ video.artist.name }}</h3>
        <ul class="other-videos" style="list-style:none;padding:0;display:flex;flex-wrap:wrap;gap:12px;">
            {% for v in artist_videos %}
                <li style="flex:0 0 250px;">
                    <a href="{% url 'video_detail' v.id %}" style="display:block;text-decoration:none;color:inherit;">
                        <img src="{{ v.thumbnail.url }}" alt="{{ v.title }}" style="width:100%;height:140px;object-fit:cover;border-radius:6px;" />
                        <strong style="display:block;margin-top:8px">{{ v.title }}</strong>
                        <div class="stats" style="font-size:0.9rem;color:#666;">
                            <span>{{ v.play_count }} vues</span>
                        </div>
                    </a>
                </li>
            {% empty %}
                <li>Aucune autre vid√©o pour cet artiste.</li>
            {% endfor %}
        </ul>
    </div>
{% endblock videoP %}
{% extends 'store/base.html' %}
{% load static %}
{% block title %}Lecture : {{ video.title }}{% endblock %}
{% block videoP %}
    <div class="spacer"></div>
    <div class="main">
        <div class="list">
            <div class="list-item">
                <div class="main-player">
                    <video controls poster="{{ video.thumbnail.url }}" preload="metadata" style="width:100%;max-width:900px;border-radius:10px;">
                        <source src="{{ video.file.url }}" type="video/mp4">
                        Votre navigateur ne supporte pas la lecture vid√©o.
                    </video>
                    <h2 style="margin-top:10px">{{ video.title }}</h2>
                    <div class="video-stats">
                        <span><i class="fa-regular fa-eye"></i> {{ video.play_count }}</span>
                        <span style="margin-left:12px"><i class="fa-solid fa-download"></i> {{ video.download_count }}</span>
                        <span style="margin-left:12px"><i class="fa-regular fa-heart"></i> {{ video.like_count }}</span>
                    </div>
                </div>
            </div>
        </div>

        <h3 style="margin-top:24px">Autres vid√©os de {{ video.artist.name }}</h3>
        <ul class="other-videos" style="list-style:none;padding:0;display:flex;flex-wrap:wrap;gap:12px;">
            {% for v in artist_videos %}
                <li style="flex:0 0 250px;">
                    <a href="{% url 'video_detail' v.id %}" style="display:block;text-decoration:none;color:inherit;">
                        <img src="{{ v.thumbnail.url }}" alt="{{ v.title }}" style="width:100%;height:140px;object-fit:cover;border-radius:6px;" />
                        <strong style="display:block;margin-top:8px">{{ v.title }}</strong>
                        <div class="stats" style="font-size:0.9rem;color:#666;">
                            <span>{{ v.play_count }} vues</span>
                        </div>
                    </a>
                </li>
            {% empty %}
                <li>Aucune autre vid√©o pour cet artiste.</li>
            {% endfor %}
        </ul>
    </div>
{% endblock videoP %}
{% extends 'store/base.html' %}
{% block title %}Page principale{% endblock %}
{% block videoP %}
    <style>
        {% comment %} body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; } {% endcomment %}
        /* Make container background transparent so the page background shows through */
        .container { background: transparent; padding: 20px; border-radius: 8px; max-width: 800px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        {% comment %} {% endcomment %}
    </style>


    <div class="spacer"></div>
    <div class="main">
    <div class="list">
        {% comment %} {% for video in object_list %} {% endcomment %}
        <div class="list-item">
            <div class="">
                <div class="main-player">
                    <video id="mainVideo" muted playsinline preload="metadata" controls >
                        <source src="{{ video.file.url }}" type="video/mp4">
                        Votre navigateur ne supporte pas la lecture vid√©o.

                    </video>
                    <button id="ytMuteBtn" class="yt-mute-btn">
                          <i class="bi bi-volume-mute-fill"></i>
                    </button>
                    
                    <h3>{{ video.title }}</h3>
                    <div class="video-stats">
                        <span><i class="fa-regular fa-eye"></i></ion-icon> {{ video.play_count }}</span>
                        <span><i class="fa-solid fa-download"></i> {{ video.download_count }}</span>
                        <span><i class="fa-regular fa-heart"></i> {{ video.like_count }}</span>
                    </div>
                    {% comment %} <button id="pipBtn" class="pip-btn">üì∫</button> {% endcomment %}
                </div>

                {% comment %} <div id="miniPlayerContainer"></div> {% endcomment %}
            </div>
        </div>

        {% comment %} {% endfor %} {% endcomment %}
    </div>
    <h2>Autres vid√©os de {{ video.artist.name }}</h2>

<div class="carousel-container">
    <button class="carousel-button left" onclick="scrollCarousel('left')" aria-label="Pr√©c√©dent" title="Pr√©c√©dent" aria-hidden="true" tabindex="-1">&#10094;</button>

    {% comment %} <div class="carousel-track" id="carousel-track"> {% endcomment %}
    <div class="carousel-track" id="carousel-track">
    
        {% for video in artist_videos %}
        <div class="list-item">
            <div class="card">
                <a href="#" 
                class="video-link" 
                data-src="{{ video.file.url }}" 
                data-title="{{ video.title }}" 
                data-views="{{ video.play_count }}"
                data-downloads="{{ video.download_count }}"
                data-likes="{{ video.like_count }}">
                    <img src="{{ video.thumbnail.url }}" alt="{{ video.title }}">
                    <h3>{{ video.title }}</h3>
                    <div class="stats">
                        <span><i class="fa-regular fa-eye"></i> {{ video.play_count }}</span>
                        <span><i class="fa-solid fa-download"></i> {{ video.download_count }}</span>
                        <span><i class="fa-regular fa-heart"></i> {{ video.like_count }}</span>
                    </div>
                    <div class="play-icon">
                        <i class="fa fa-play"></i> <!-- Font Awesome ou autre ic√¥ne -->
                    </div>
                </a>
            </div>
        </div>

        {% empty %}
        <p>Aucune autre vid√©o pour cet artiste.</p>
        {% endfor %}
    </div>
    </div>

    <button class="carousel-button right" onclick="scrollCarousel('right')" aria-label="Suivant" title="Suivant" aria-hidden="true" tabindex="-1">&#10095;</button>
</div>

</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const video = document.getElementById("mainVideo");
    const muteBtn = document.getElementById("ytMuteBtn");
    const pipBtn = document.getElementById("pipBtn");
    const miniContainer = document.getElementById("miniPlayerContainer");

    let pipActive = false;  // <-- Nouveau drapeau
    let miniVisible = false;

    // -------------------
    // MUTE / UNMUTE
    // -------------------
    const muteIcon = muteBtn.querySelector("i");
    const updateMuteIcon = () => {
        if(video.muted){
            muteBtn.classList.remove("hidden");
            muteIcon.className = "bi bi-volume-mute-fill";
        } else {
            muteBtn.classList.add("hidden");
        }
    }
    muteBtn.addEventListener("click", () => {
        video.muted = false;
        video.volume = 1;
        updateMuteIcon();
        handleUnmute(video);
    });
    updateMuteIcon();

    // -------------------
    // PIP Button
    // -------------------
    pipBtn.addEventListener("click", async () => {
        if ('pictureInPictureEnabled' in document) {
            try {
                if(video !== document.pictureInPictureElement){
                    await video.requestPictureInPicture();
                    pipActive = true; // PiP actif
                    // Masque mini-player si PiP
                    if(miniVisible){
                        miniPlayer.style.display = "none";
                        miniVisible = false;
                    }
                } else {
                    await document.exitPictureInPicture();
                    pipActive = false;
                }
            } catch(err){
                console.error("Erreur PiP :", err);
            }
        } else {
            alert("Picture-in-Picture non support√©");
        }
    });

    // -------------------
    // Mini-player flottant au scroll
    // -------------------
    const miniPlayer = document.createElement("div");
    miniPlayer.className = "mini-player";
    const miniVideo = video.cloneNode(true);
    miniVideo.muted = video.muted;
    miniPlayer.appendChild(miniVideo);
    miniContainer.appendChild(miniPlayer);

    window.addEventListener("scroll", () => {
        const isUnmuted = localStorage.getItem("videoUnmuted") === "true";
        if(window.scrollY > 300 && !miniVisible && !pipActive && isUnmuted){
            miniPlayer.style.display = "block";
            miniVideo.play();
            miniVisible = true;
        } else if((window.scrollY < 300 || pipActive || !isUnmuted) && miniVisible){
            miniPlayer.style.display = "none";
            miniVideo.pause();
            miniVisible = false;
        }
    });

    // Clique sur mini-player pour revenir √† la vid√©o principale
    miniPlayer.addEventListener("click", () => {
        window.scrollTo({ top: video.offsetTop - 20, behavior: 'smooth' });
        miniPlayer.style.display = "none";
        miniVisible = false;
    });
});


document.addEventListener("DOMContentLoaded", () => {
    const player = document.querySelector(".main-player");

    if (!player) {
        console.error("main-player introuvable !");
        return;
    }

    // Force apparition imm√©diate en cas de bug
    function showPlayer() {
        player.classList.add("in-view");
    }

    // Si Observer n‚Äôest pas support√© ‚Üí afficher imm√©diatement
    if (!("IntersectionObserver" in window)) {
        showPlayer();
        return;
    }

    const obs = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                showPlayer();
                obs.disconnect(); // Animation une seule fois
            }
        });
    });

    obs.observe(player);

    // S√©curit√© : apr√®s 800ms ‚Üí afficher quand m√™me
    setTimeout(showPlayer, 800);
});

document.addEventListener("DOMContentLoaded", () => {
    const video = document.getElementById("mainVideo");

    if (!video) return;

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const isMuted = video.muted; // vrai si muet

            if (entry.isIntersecting) {
                // La vid√©o entre dans la vue ‚Üí autoplay (toujours)
                video.play().catch(e => console.log("Autoplay bloqu√©:", e));
            } else {
                // La vid√©o sort de la vue ‚Üí pause seulement si muette
                if (isMuted) {
                    video.pause();
                }
                // Sinon (unmute) ‚Üí continue de jouer
            }
        });
    }, { threshold: 0.5 });

    observer.observe(video);
});





function scrollCarousel(direction) {
    const track = document.getElementById("carousel-track");
    const scrollAmount = 300;

    if (direction === "left") {
        track.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    } else {
        track.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }
}


document.querySelectorAll(".video-link").forEach(link => {
    link.addEventListener("click", e => {
        e.preventDefault();

        const src = link.dataset.src;
        const title = link.dataset.title;
        const views = link.dataset.views;
        const downloads = link.dataset.downloads;
        const likes = link.dataset.likes;

        const mainVideo = document.getElementById("mainVideo");
        const titleEl = document.querySelector(".main-player h3");
        const stats = document.querySelector(".video-stats");

        if (!mainVideo || !titleEl || !stats) return;

        // Change source
        mainVideo.src = src;
        mainVideo.load();
        mainVideo.play().catch(err => console.log("Autoplay bloqu√© :", err));

        // Mettre √† jour titre et stats
        titleEl.textContent = title;
        stats.innerHTML = `
            <span><i class="fa-regular fa-eye"></i> ${views}</span>
            <span><i class="fa-solid fa-download"></i> ${downloads}</span>
            <span><i class="fa-regular fa-heart"></i> ${likes}</span>
        `;

        // Si mini-player existe ‚Üí mettre √† jour aussi
        const miniVideo = document.querySelector(".mini-player video");
        if(miniVideo){
            miniVideo.src = src;
            miniVideo.load();
        }
    });
});

</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const containers = document.querySelectorAll('.carousel-container');
    containers.forEach(container => {
        const track = container.querySelector('.carousel-track');
        const buttons = container.querySelectorAll('.carousel-button');
        // ensure initial aria and tabindex states
        buttons.forEach(b => { b.setAttribute('aria-hidden', 'true'); b.setAttribute('tabindex', '-1'); });

        let timeoutId;
        // Check if carousel needs controls (overflow) and set class accordingly
        function updateNeedsControls(){
            if (!track) return;
            const needs = track.scrollWidth > track.clientWidth + 2;
            container.classList.toggle('needs-controls', needs);
            // hide controls and make aria-hidden if not needed
            if (!needs){
                container.classList.remove('show-controls');
                buttons.forEach(b => { b.setAttribute('aria-hidden','true'); b.setAttribute('tabindex','-1'); });
            } else {
                // If needs, allow the normal hover/focus logic to show controls
                // Set initial aria-hidden true until visible
                buttons.forEach(b => { if (!container.classList.contains('show-controls')){ b.setAttribute('aria-hidden','true'); b.setAttribute('tabindex','-1'); } });
            }
        }
        // run initial check (take into account images loading slow)
        updateNeedsControls();
        function showControlsTemporarily() {
            clearTimeout(timeoutId);
            container.classList.add('show-controls');
            buttons.forEach(b => { b.setAttribute('aria-hidden','false'); b.setAttribute('tabindex','0'); });
            timeoutId = setTimeout(() => {
                container.classList.remove('show-controls');
                buttons.forEach(b => { b.setAttribute('aria-hidden','true'); b.setAttribute('tabindex','-1'); });
            }, 2400);
        }

        container.addEventListener('touchstart', function(e){ if (container.classList.contains('needs-controls')) showControlsTemporarily(); }, { passive: true });
        container.addEventListener('mouseenter', () => {
            if (!container.classList.contains('needs-controls')) return;
            container.classList.add('show-controls');
            buttons.forEach(b => { b.setAttribute('aria-hidden','false'); b.setAttribute('tabindex','0'); });
        });
        container.addEventListener('mouseleave', () => {
            if (!container.classList.contains('needs-controls')) return;
            container.classList.remove('show-controls');
            buttons.forEach(b => { b.setAttribute('aria-hidden','true'); b.setAttribute('tabindex','-1'); });
        });
        container.addEventListener('focusin', () => {
            if (!container.classList.contains('needs-controls')) return;
            container.classList.add('show-controls');
            buttons.forEach(b => { b.setAttribute('aria-hidden','false'); b.setAttribute('tabindex','0'); });
        });
        container.addEventListener('focusout', () => {
            if (!container.classList.contains('needs-controls')) return;
            container.classList.remove('show-controls');
            buttons.forEach(b => { b.setAttribute('aria-hidden','true'); b.setAttribute('tabindex','-1'); });
        });
        // Make left/right keyboard navigation global while focused on a child
        container.addEventListener('keydown', function(e){
            if (e.key === 'ArrowLeft') {
                e.preventDefault(); scrollCarousel('left');
            } else if (e.key === 'ArrowRight') {
                e.preventDefault(); scrollCarousel('right');
            }
        });
        // keep an eye on resize & content load to re-check overflow
        window.addEventListener('resize', updateNeedsControls);
        // re-check when images inside the track load (covers)
        const imgs = track ? track.querySelectorAll('img') : [];
        imgs.forEach(img => img.addEventListener('load', updateNeedsControls));
    });
});
</script>



{% endblock videoP %}